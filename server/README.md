# D&D-Lite — Backend

Бэкенд для веб-приложения D&D-Lite. Реализован на FastAPI (Python).

## Запуск в режиме разработки

```bash
uvicorn server.src.main:app --reload
```

## Структура

- `src/` — исходный код
- `tests/` — тесты (pytest)

## Установка зависимостей

```bash
pip install -r requirements.txt
```

## Переменные окружения

- Все секретные ключи и настройки должны храниться в файле `.env` (НЕ коммитить в git, он уже в .gitignore).
- Пример структуры — в `server/.env.example`.

## Новый сценарий работы

- **Нет регистрации и логина.**
- Пользователь подключается к комнате по ID, отправляя уникальный `client_id` (генерируется на клиенте и хранится в браузере).
- Первый подключившийся становится ГМ (game master).
- У каждого игрока есть панель персонажа (имя, описание, цвет токена), которую он может редактировать только для себя.
- ГМ может кикнуть любого игрока (кроме себя). Кикнутый не может вернуться в комнату (по этому client_id).
- Список игроков и их инфо синхронизируется между всеми участниками комнаты.

## WebSocket API (ws://.../ws/game/{session_id})

**Первое сообщение:**

```json
{ "client_id": "..." }
```

**Дальнейшие экшены:**

- `get_players` — получить список игроков
- `update_player_info` — обновить свою панель персонажа (имя, описание, цвет)
  - payload: `{ "name": "...", "description": "...", "color": "#..." }`
- `kick_player` — (только ГМ) кикнуть игрока
  - payload: `{ "client_id": "..." }`
- ... (остальные экшены: карта, токены, кубики, инициатива)

**Ответы:**

- `{ "action": "players_state", "payload": [ ... ] }` — обновлённый список игроков
- `{ "error": "kicked" }` — если игрок кикнут
- `{ "error": "Only GM can kick" }` — если не-ГМ пытается кикнуть

## Запуск тестов

```bash
pytest server/tests --maxfail=3 --disable-warnings -v
```

## Основные эндпоинты

- `/register` — регистрация пользователя (POST, form-data: username, password)
- `/login` — вход, получение JWT (POST, form-data: username, password)
- `/character-templates` — CRUD шаблонов персонажей (требует JWT):
  - `POST` — создать шаблон (json: name, description, color)
  - `GET` — получить список своих шаблонов
  - `PUT /character-templates/{id}` — обновить шаблон
  - `DELETE /character-templates/{id}` — удалить шаблон

## Описание

Добавлена поддержка JWT-аутентификации (FastAPI, passlib, python-jose).
