<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D&D Игровое поле</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    :root{ --cell-size:40px; }
    .grid-cell{width:var(--cell-size);height:var(--cell-size);border:1px solid #ccc;background:#f9f9f9;transition:background .1s;position:relative;}
    .token{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:80%;height:80%;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;line-height:1;color:#fff;box-shadow:0 2px 5px rgba(0,0,0,.2);cursor:grab;user-select:none;}
    .dice-face{width:60px;height:60px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#e0eaff;color:#1d4ed8;font:700 24px/1 system-ui;box-shadow:0 2px 5px rgba(0,0,0,.2);cursor:pointer;transition:transform .2s;}
    .dice-face:hover{transform:scale(1.05);}
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
<div class="container mx-auto p-4">
  <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">D&D Игровое поле</h1>
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Инструменты -->
    <div class="bg-white p-4 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Инструменты</h2>
      <div class="space-y-3">
        <button id="brush-btn"  class="w-full flex items-center px-4 py-2 rounded-md"><i class="fas fa-paint-brush mr-2"></i>Кисть</button>
        <button id="eraser-btn" class="w-full flex items-center px-4 py-2 rounded-md"><i class="fas fa-eraser mr-2"></i>Ластик</button>
        <button id="hand-btn"   class="w-full flex items-center px-4 py-2 rounded-md"><i class="fas fa-hand-paper mr-2"></i>Рука</button>
        <div class="flex items-center mt-4"><label class="mr-2">Цвет:</label><input id="color-picker" type="color" value="#3b82f6" class="w-8 h-8 rounded-full border"></div>
        <div class="flex items-center mt-2"><label class="mr-2">Размер:</label><select id="brush-size" class="p-1 border rounded"><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option></select></div>
      </div>
    </div>

    <!-- Кубик -->
    <div class="bg-white p-4 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Кубик</h2>
      <select id="dice-select" class="w-full mb-4 p-2 border rounded-md">
        <option value="4">D4</option><option value="6" selected>D6</option><option value="8">D8</option><option value="10">D10</option><option value="12">D12</option><option value="20">D20</option><option value="100">D100</option>
      </select>
      <div class="flex justify-center mb-2"><div id="dice-face" class="dice-face">?</div></div>
      <div id="dice-result" class="text-center font-bold text-lg text-gray-700"></div>
    </div>

    <!-- Фишки -->
    <div class="bg-white p-4 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Фишки</h2>
      <button id="create-token-btn" class="w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 mb-4"><i class="fas fa-plus mr-2"></i>Создать фишку</button>
      <div id="token-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
    </div>

    <!-- Поле -->
    <div class="lg:col-span-3 bg-white p-4 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Игровое поле</h2>
      <div class="flex justify-between items-center mb-4">
        <div><label class="mr-2">Размер сетки</label><input id="grid-size" type="number" min="1" value="20" class="w-24 p-1 border rounded-md"></div>
        <button id="clear-grid-btn" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-md hover:bg-gray-300">Очистить поле</button>
      </div>
      <div id="game-grid" class="grid border border-gray-300" style="max-height:600px; max-width:100%; overflow:auto; display:inline-grid;"></div>
    </div>
  </div>
</div>

<!-- Модал -->
<div id="token-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-full max-w-sm">
    <h3 class="text-xl font-semibold mb-4">Фишка</h3>
    <div class="space-y-4">
      <div><label class="block mb-1">Имя</label><input id="token-name" type="text" class="w-full p-2 border rounded-md"></div>
      <div><label class="block mb-1">Цвет</label><input id="token-color" type="color" value="#3b82f6" class="w-16 h-8 border rounded"></div>
      <div><label class="block mb-1">Описание</label><textarea id="token-description" rows="2" class="w-full p-2 border rounded-md"></textarea></div>
      <div><label class="block mb-1">Позиция (X, Y)</label><div class="flex space-x-2"><input id="token-x" type="number" min="0" class="w-1/2 p-2 border rounded"><input id="token-y" type="number" min="0" class="w-1/2 p-2 border rounded"></div></div>
    </div>
    <div class="flex justify-between mt-6"><button id="delete-token-btn" class="hidden bg-red-500 text-white px-4 py-2 rounded-md">Удалить</button><div class="space-x-2"><button id="cancel-token-btn" class="bg-gray-300 px-4 py-2 rounded-md">Отмена</button><button id="save-token-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md">Сохранить</button></div></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded',()=>{
    /* === State === */
    let tokens=[];
    let currentTokenId=null;
    let selectedTool='brush';
    let selectedColor=document.getElementById('color-picker').value;
    let brushSize=1;
    let gridSize=parseInt(document.getElementById('grid-size').value);
    let painting=false;
    const cellColors=new Map(); // сохраняем цвета клеток по ключу "x_y"

    /* === DOM refs === */
    const gameGrid=document.getElementById('game-grid');
    const brushBtn=document.getElementById('brush-btn');
    const eraserBtn=document.getElementById('eraser-btn');
    const handBtn=document.getElementById('hand-btn');
    const colorPicker=document.getElementById('color-picker');
    const brushSizeSelect=document.getElementById('brush-size');
    const gridSizeInput=document.getElementById('grid-size');
    const clearGridBtn=document.getElementById('clear-grid-btn');
    const diceSelect=document.getElementById('dice-select');
    const diceFace=document.getElementById('dice-face');
    const diceResult=document.getElementById('dice-result');
    const tokenModal=document.getElementById('token-modal');
    const createTokenBtn=document.getElementById('create-token-btn');
    const tokenNameInput=document.getElementById('token-name');
    const tokenColorInput=document.getElementById('token-color');
    const tokenDescInput=document.getElementById('token-description');
    const tokenXInput=document.getElementById('token-x');
    const tokenYInput=document.getElementById('token-y');
    const deleteTokenBtn=document.getElementById('delete-token-btn');
    const cancelTokenBtn=document.getElementById('cancel-token-btn');
    const saveTokenBtn=document.getElementById('save-token-btn');
    const tokenList=document.getElementById('token-list');

    /* === Helpers === */
    function key(x,y){return `${x}_${y}`;}

    function setActiveTool(tool){
      selectedTool=tool;
      brushBtn.classList.toggle('bg-blue-200',tool==='brush');
      eraserBtn.classList.toggle('bg-red-200',tool==='eraser');
      handBtn.classList.toggle('bg-yellow-200',tool==='hand');
      gameGrid.style.cursor=(tool==='brush'||tool==='eraser')?'crosshair':'default';
    }

    function buildGrid(){
      // сохранить текущие цвета
      cellColors.clear();
      document.querySelectorAll('.grid-cell').forEach(c=>{
        const bg=c.style.background;
        if(bg){ cellColors.set(key(c.dataset.x,c.dataset.y),bg); }
      });
      // очистить
      gameGrid.innerHTML='';
      gameGrid.style.gridTemplateColumns=`repeat(${gridSize}, var(--cell-size))`;
      gameGrid.style.gridAutoRows='var(--cell-size)';
      for(let y=0;y<gridSize;y++){
        for(let x=0;x<gridSize;x++){
          const cell=document.createElement('div');
          cell.className='grid-cell';
          cell.dataset.x=x;
          cell.dataset.y=y;
          const saved=cellColors.get(key(x,y));
          if(saved) cell.style.background=saved;
          gameGrid.appendChild(cell);
        }
      }
      // clamp tokens
      tokens.forEach(t=>{t.x=Math.min(gridSize-1,t.x);t.y=Math.min(gridSize-1,t.y);});
      redrawTokens();
    }

    function paintCell(cx,cy,color){
      const cell=document.querySelector(`.grid-cell[data-x="${cx}"][data-y="${cy}"]`);
      if(!cell) return;
      cell.style.background=color;
      if(color) cellColors.set(key(cx,cy),color); else cellColors.delete(key(cx,cy));
    }

    function applyTool(x,y){
      const half=Math.floor(brushSize/2);
      for(let dy=-half;dy<brushSize-half;dy++){
        for(let dx=-half;dx<brushSize-half;dx++){
          const tx=x+dx, ty=y+dy;
          if(tx<0||ty<0||tx>=gridSize||ty>=gridSize) continue;
          if(selectedTool==='brush') paintCell(tx,ty,selectedColor);
          else if(selectedTool==='eraser') paintCell(tx,ty,'');
        }
      }
    }

    function placeToken(tok){
      document.querySelector(`.token[data-id="${tok.id}"]`)?.remove();
      const cell=document.querySelector(`.grid-cell[data-x="${tok.x}"][data-y="${tok.y}"]`);
      if(!cell) return;
      const el=document.createElement('div');
      el.className='token';
      el.dataset.id=tok.id;
      el.style.background=tok.color;
      el.textContent=tok.name[0].toUpperCase();
      el.draggable=true;
      el.addEventListener('dragstart',ev=>{
        if(selectedTool!=='hand'){ev.preventDefault();return;}
        ev.dataTransfer.setData('text/plain',tok.id);
      });
      cell.appendChild(el);
    }
    function redrawTokens(){tokens.forEach(placeToken);}

    function refreshTokenList(){
      tokenList.innerHTML='';
      tokens.forEach(tok=>{
        const row=document.createElement('div');
        row.className='flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer';
        row.innerHTML=`<span class='inline-block w-4 h-4 rounded-full mr-2' style='background:${tok.color}'></span>${tok.name}`;
        row.addEventListener('click',()=>openTokenModal(tok));
        tokenList.appendChild(row);
      });
    }

    function openTokenModal(tok=null){
      if(tok){ currentTokenId=tok.id; tokenNameInput.value=tok.name; tokenColorInput.value=tok.color; tokenDescInput.value=tok.description; tokenXInput.value=tok.x; tokenYInput.value=tok.y; deleteTokenBtn.classList.remove('hidden'); }
      else{ currentTokenId=null; tokenNameInput.value=''; tokenColorInput.value='#3b82f6'; tokenDescInput.value=''; tokenXInput.value=0; tokenYInput.value=0; deleteTokenBtn.classList.add('hidden'); }
      tokenModal.classList.remove('hidden'); tokenModal.classList.add('flex');
    }
    function closeTokenModal(){ tokenModal.classList.add('hidden'); tokenModal.classList.remove('flex'); }

    /* === Event wiring === */
    brushBtn.addEventListener('click',()=>setActiveTool('brush'));
    eraserBtn.addEventListener('click',()=>setActiveTool('eraser'));
    handBtn.addEventListener('click',()=>setActiveTool('hand'));

    colorPicker.addEventListener('input',e=>selectedColor=e.target.value);
    brushSizeSelect.addEventListener('change',e=>brushSize=parseInt(e.target.value));
    clearGridBtn.addEventListener('click',()=>{document.querySelectorAll('.grid-cell').forEach(c=>c.style.background='');cellColors.clear();});
    gridSizeInput.addEventListener('change',()=>{gridSize=Math.max(1, parseInt(gridSizeInput.value) || 1); buildGrid();});

    gameGrid.addEventListener('mousedown',e=>{
      if(selectedTool==='hand') return;
      const cell=e.target.closest('.grid-cell'); if(!cell) return;
      painting=true;
      applyTool(parseInt(cell.dataset.x),parseInt(cell.dataset.y));
    });
    gameGrid.addEventListener('mousemove',e=>{
      if(!painting) return; const cell=e.target.closest('.grid-cell'); if(!cell) return;
      applyTool(parseInt(cell.dataset.x),parseInt(cell.dataset.y));
    });
    document.addEventListener('mouseup',()=>painting=false);

    gameGrid.addEventListener('dragover',e=>{ if(selectedTool==='hand') e.preventDefault(); });
    gameGrid.addEventListener('drop',e=>{
      if(selectedTool!=='hand') return; e.preventDefault();
      const id=e.dataTransfer.getData('text/plain'); const tok=tokens.find(t=>t.id===id);
      const cell=e.target.closest('.grid-cell'); if(!(tok&&cell)) return;
      tok.x=parseInt(cell.dataset.x); tok.y=parseInt(cell.dataset.y);
      redrawTokens(); refreshTokenList();
    });

    diceFace.addEventListener('click',()=>{
      const sides=parseInt(diceSelect.value);
      const result=Math.floor(Math.random()*sides)+1;
      diceFace.textContent='…'; diceFace.style.transform='rotate(360deg) scale(1.2)';
      setTimeout(()=>{diceFace.style.transform='rotate(0) scale(1)'; diceFace.textContent=result; diceResult.textContent=`Выпало: ${result}`;},500);
    });
    diceSelect.addEventListener('change',()=>{diceFace.textContent='?'; diceResult.textContent='';});

    createTokenBtn.addEventListener('click',()=>openTokenModal());
    saveTokenBtn.addEventListener('click',()=>{
      const name=tokenNameInput.value.trim(); if(!name) return alert('Введите имя');
      const color=tokenColorInput.value; const x=parseInt(tokenXInput.value); const y=parseInt(tokenYInput.value);
      if(x<0||y<0||x>=gridSize||y>=gridSize) return alert('Позиция вне поля');
      const desc=tokenDescInput.value.trim();
      if(currentTokenId){ Object.assign(tokens.find(t=>t.id===currentTokenId),{name,color,description:desc,x,y}); }
      else{ tokens.push({id:Date.now().toString(),name,color,description:desc,x,y}); }
      redrawTokens(); refreshTokenList(); closeTokenModal();
    });
    deleteTokenBtn.addEventListener('click',()=>{ tokens=tokens.filter(t=>t.id!==currentTokenId); redrawTokens(); refreshTokenList(); closeTokenModal(); });
    cancelTokenBtn.addEventListener('click',closeTokenModal);

    /* === Init === */
    setActiveTool('brush');
    buildGrid();
  });
</script>
</body>
</html>
